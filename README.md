
# Smart Contract DevOps

This repository contains an exemplary DevOps supported setup for Ethereum smart contract development with Continuous Integration / Continuous Deployment.
The core framework is [hardhat](https://github.com/nomiclabs/hardhat).

## Prerequisites

`Node.js` and `npm` are required.  
For development, the following versions were used:
- `Node.js` – v16.7.0
- `npm` – 7.20.3

## Installation

Run ```npm install``` to install all dependencies specified in `package.json` and prepare husky hooks.

## General Project Structure

- The standard `package.json` file with several helpful script commands
- `hardhat.config.js` file with prepared settings for dev and prod networks
- `.husky` folder containing pre-commit hooks configuration
- `.env` file for custom variables
- Multiple configuration files in the project root for additional developers tools

### Excerpt of Important Tools

- [husky](https://github.com/typicode/husky): Modern native git hooks (used to setup pre-commit tasks)
- [hardhat-abi-exporter](https://hardhat.org/plugins/hardhat-abi-exporter.html): Exports generated ABIs on compilation
- [hardhat-contract-sizer](https://hardhat.org/plugins/hardhat-contract-sizer.html): Outputs Solidity contract sizes on compilation
- [hardhat-deploy](https://hardhat.org/plugins/hardhat-deploy.html): Plugin for replicable deployments and easy testing
- [hardhat-docgen](https://hardhat.org/plugins/hardhat-docgen.html): Generates documentation from NatSpec comments on compilation
- [hardhat-gas-reporter](https://hardhat.org/plugins/hardhat-gas-reporter.html): Generates gas reports
- [hardhat-watcher](https://hardhat.org/plugins/hardhat-watcher.html): Optionally run actions when files change (e.g., auto compile)
- [slither](https://github.com/crytic/slither): Static analysis framework used to inspect Solidity smart contracts
- [solhint](https://github.com/protofire/solhint): A linting utility for Solidity code
- [solidity-coverage](https://github.com/sc-forks/solidity-coverage): Determines code coverage for Solidity testing
- [trufflehog3](https://github.com/feeltheajf/trufflehog3): A secret scanner that searches through git repositories for secrets
- [semantic-release](https://github.com/semantic-release/semantic-release): Fully automated version management and package publishing following the [Semantic Versioning specification](https://semver.org/)
  - Basically this allows versioning (major/minor/patch) based on commit [prefixes](https://github.com/angular/angular.js/blob/master/DEVELOPERS.md#type). As part of publishing a package, semantic-release bumps the version in package.json. Further, it automates the publishing of NPM packages to GitLab's Package Registry and auto-generates releases on the Releases page. In order for this to work, the pipeline requires a custom environment variable named GITLAB_TOKEN or GL_TOKEN, a project access token with API scope. This token can be generated by navigating to Project > Settings > Access Tokens. Be sure to mask this variable (otherwise it may be printed in plaintext in the job output).

### Configuration

#### `hardhat.config.js`
The file contains configuration regarding the development environment setup and the blockchain connection. For more information read [hardhat configuration](https://hardhat.org/config/).
- `networks`: Each of the networks subentry corresponds to the hardhat *--network* parameter.
- `solidity`: This section is used to specify Solidity compiler settings (e.g., compiler version).

#### `.env` *Needs to be created manually*

For the development the file `.env` with filled parameters must exist in the root directory of the project. The provided `.env.example` file serves as a template. It contains all parameters that must be present in the `.env` file, but without actual values (only parameter names). At the moment the most important are the following:
- `INFURA_API_KEY`: The project does not use its own Ethereum node, so an external provider, Infura, is used. To get the key visit the [infura website](https://infura.io/).
- `MNEMONIC`= Mnemonic phrase (i.e.,private key) of the wallet used for interacting with the networks. Contracts are provisioned from an account (determined from the private key), which should have enough funds to provision the contracts.
- `ETHERSCAN_API_KEY`: Block explorer key needed for contract verification.
- `COINMARKETCAP_API_KEY`: Crypto data provider used to fetch exchange rates for gas fee calcualtion in gas reports.

### General Workflow

#### Pre-commit hooks
Linting Smart Contracts  
Scanning for Secrets 

### DevOps (CI/CD) using Gitlab CI

#### Generated Artifacts
- `abi` folder containing the smart contract ABIs after compilation
- `docs` folder containing the documentation derived from NatSpec annotations in smart contracts

